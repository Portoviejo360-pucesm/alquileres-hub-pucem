// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Mapped Tables (from general_schema.sql)
// =============================================================================

model Usuario {
  id_usuario        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rol_id            Int       @default(2)
  nombres_completos String    @db.VarChar
  correo            String    @unique @db.VarChar
  password_hash     String?   @db.Text
  fecha_registro    DateTime? @default(now()) @db.Timestamp(6)

  // Relations
  rol            Rol                @relation(fields: [rol_id], references: [id_rol])
  propiedades    Propiedad[]
  reservas       Reserva[]
  verificaciones PerfilVerificado[]

  // Incidents Module Relations
  incidencias_reportadas  Incidencia[]            @relation("Reportante")
  incidencias_asignadas   Incidencia[]            @relation("Responsable")
  incidencias_bitacora    BitacoraMantenimiento[]
  incidencias_historial   HistorialIncidencia[]
  incidencias_comentarios Comentario[]
  incidencias_adjuntos    Adjunto[]

  @@map("usuarios")
}

model Rol {
  id_rol Int    @id @default(autoincrement())
  nombre String @unique @db.VarChar

  usuarios Usuario[]

  @@map("roles")
}

model Propiedad {
  id_propiedad        Int       @id @default(autoincrement())
  propietario_id      String    @db.Uuid
  estado_id           Int
  publico_objetivo_id Int?
  titulo_anuncio      String    @db.VarChar
  descripcion         String?   @db.Text
  precio_mensual      Decimal   @db.Decimal
  direccion_texto     String?   @db.VarChar
  latitud_mapa        Decimal   @db.Decimal
  longitud_mapa       Decimal   @db.Decimal
  es_amoblado         Boolean?  @default(false)
  fecha_creacion      DateTime? @default(now()) @db.Timestamp(6)

  // Relations
  propietario Usuario             @relation(fields: [propietario_id], references: [id_usuario])
  reservas    Reserva[]
  fotos       FotoPropiedad[]
  servicios   PropiedadServicio[]

  // Incidents Module Relations
  incidencias Incidencia[]

  @@map("propiedades")
}

model Reserva {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  usuario_id     String    @db.Uuid
  propiedad_id   Int
  fecha_entrada  DateTime  @db.Date
  fecha_salida   DateTime  @db.Date
  total_pagar    Decimal   @db.Decimal
  estado         String?   @default("PENDIENTE") // Enum handled as string in Prisma for simplicity if type not defined
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  usuario   Usuario   @relation(fields: [usuario_id], references: [id_usuario])
  propiedad Propiedad @relation(fields: [propiedad_id], references: [id_propiedad])
  contrato  Contrato?

  @@map("reserva")
}

model Contrato {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reserva_id       String    @unique @db.Uuid
  url_archivo      String    @db.Text
  fecha_generacion DateTime? @default(now()) @db.Timestamptz

  reserva Reserva @relation(fields: [reserva_id], references: [id])

  @@map("contrato")
}

model CatalogoServicio {
  id_servicio Int    @id @default(autoincrement())
  nombre      String @unique @db.VarChar

  propiedades PropiedadServicio[]

  @@map("catalogo_servicios")
}

model PropiedadServicio {
  propiedad_id       Int
  servicio_id        Int
  incluido_en_precio Boolean? @default(true)

  propiedad Propiedad        @relation(fields: [propiedad_id], references: [id_propiedad])
  servicio  CatalogoServicio @relation(fields: [servicio_id], references: [id_servicio])

  @@id([propiedad_id, servicio_id])
  @@map("propiedad_servicios")
}

model FotoPropiedad {
  id_foto      Int      @id @default(autoincrement())
  propiedad_id Int
  url_imagen   String   @db.Text
  es_principal Boolean? @default(false)

  propiedad Propiedad @relation(fields: [propiedad_id], references: [id_propiedad])

  @@map("fotos_propiedad")
}

model PerfilVerificado {
  id_verificacion    Int       @id @default(autoincrement())
  usuario_id         String    @unique @db.Uuid
  cedula_ruc         String    @unique @db.VarChar
  foto_documento_url String?   @db.Text
  telefono_contacto  String    @db.VarChar
  biografia_corta    String?   @db.Text
  esta_verificado    Boolean?  @default(false)
  fecha_solicitud    DateTime? @default(now()) @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuario_id], references: [id_usuario])

  @@map("perfil_verificado")
}

// =============================================================================
// New Tables (Incidents Module)
// =============================================================================

model Estado {
  id             Int       @id @default(autoincrement())
  codigo         String    @unique @db.VarChar(20)
  nombre         String    @db.VarChar(50)
  descripcion    String?   @db.Text
  orden          Int       @default(0)
  activo         Boolean?  @default(true)
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  incidencias Incidencia[]

  @@map("estados")
}

model Prioridad {
  id             Int       @id @default(autoincrement())
  codigo         String    @unique @db.VarChar(20)
  nombre         String    @db.VarChar(50)
  descripcion    String?   @db.Text
  nivel          Int
  color          String?   @db.VarChar(7)
  activo         Boolean?  @default(true)
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  incidencias Incidencia[]

  @@map("prioridades")
}

model Categoria {
  id             Int       @id @default(autoincrement())
  codigo         String    @unique @db.VarChar(50)
  nombre         String    @db.VarChar(100)
  descripcion    String?   @db.Text
  activo         Boolean?  @default(true)
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  incidencias Incidencia[]

  @@map("categorias")
}

model Incidencia {
  id          Int    @id @default(autoincrement())
  titulo      String @db.VarChar(200)
  descripcion String @db.Text

  estado_id    Int
  prioridad_id Int
  categoria_id Int?

  propiedad_id          Int
  usuario_reportante_id String  @db.Uuid
  responsable_id        String? @db.Uuid

  fecha_creacion      DateTime? @default(now()) @db.Timestamptz
  fecha_actualizacion DateTime? @default(now()) @db.Timestamptz
  fecha_resolucion    DateTime? @db.Timestamptz

  // Relations
  estado    Estado     @relation(fields: [estado_id], references: [id])
  prioridad Prioridad  @relation(fields: [prioridad_id], references: [id])
  categoria Categoria? @relation(fields: [categoria_id], references: [id])
  propiedad Propiedad  @relation(fields: [propiedad_id], references: [id_propiedad])

  reportante  Usuario  @relation("Reportante", fields: [usuario_reportante_id], references: [id_usuario])
  responsable Usuario? @relation("Responsable", fields: [responsable_id], references: [id_usuario])

  bitacora    BitacoraMantenimiento[]
  historial   HistorialIncidencia[]
  comentarios Comentario[]
  adjuntos    Adjunto[]

  @@index([propiedad_id])
  @@index([usuario_reportante_id])
  @@map("incidencias")
}

model BitacoraMantenimiento {
  id             Int       @id @default(autoincrement())
  incidencia_id  Int
  usuario_id     String    @db.Uuid
  descripcion    String    @db.Text
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  incidencia Incidencia @relation(fields: [incidencia_id], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuario_id], references: [id_usuario])

  @@map("bitacora_mantenimiento")
}

model HistorialIncidencia {
  id             Int       @id @default(autoincrement())
  incidencia_id  Int
  usuario_id     String    @db.Uuid
  accion         String    @db.VarChar(100)
  descripcion    String?   @db.Text
  valor_anterior String?   @db.Text
  valor_nuevo    String?   @db.Text
  fecha_cambio   DateTime? @default(now()) @db.Timestamptz

  incidencia Incidencia @relation(fields: [incidencia_id], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuario_id], references: [id_usuario])

  @@map("historial_incidencias")
}

model Comentario {
  id                  Int       @id @default(autoincrement())
  incidencia_id       Int
  usuario_id          String    @db.Uuid
  contenido           String    @db.Text
  es_interno          Boolean?  @default(false)
  fecha_creacion      DateTime? @default(now()) @db.Timestamptz
  fecha_actualizacion DateTime? @db.Timestamptz

  incidencia Incidencia @relation(fields: [incidencia_id], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuario_id], references: [id_usuario])

  @@map("comentarios")
}

model Adjunto {
  id             Int       @id @default(autoincrement())
  incidencia_id  Int
  usuario_id     String    @db.Uuid
  nombre_archivo String    @db.VarChar(255)
  url_archivo    String    @db.Text
  tipo_mime      String?   @db.VarChar(100)
  tamanio_bytes  BigInt?
  fecha_creacion DateTime? @default(now()) @db.Timestamptz

  incidencia Incidencia @relation(fields: [incidencia_id], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuario_id], references: [id_usuario])

  @@map("adjuntos")
}
